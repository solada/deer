<!-- pages/post-detail/post-detail.wxml -->
<view class="container">
  <!-- å¸–å­å†…å®¹ -->
  <view class="post-detail card" wx:if="{{post}}">
    <view class="post-header">
      <view class="author-info">
        <view class="avatar">
          {{post.nickname ? post.nickname.charAt(0) : post.username.charAt(0)}}
        </view>
        <view class="author-details">
          <text class="author-name text-base">{{post.nickname || post.username}}</text>
          <text class="post-time text-xs text-muted">{{post.formatted_time}}</text>
        </view>
      </view>
      
      <!-- åˆ é™¤æŒ‰é’® - åªæœ‰ä½œè€…å¯è§ -->
      <view class="post-actions" wx:if="{{isLoggedIn && userInfo.id === post.user_id}}">
        <text class="delete-btn text-danger text-sm" bindtap="deletePost">åˆ é™¤</text>
      </view>
    </view>
    
    <view class="post-content">
      <text class="post-title text-xl">{{post.title}}</text>
      <text class="post-body text-base">{{post.content}}</text>
    </view>
  </view>

  <!-- è¯„è®ºåŒº -->
  <view class="comments-section">
    <view class="section-header">
      <text class="section-title text-lg">è¯„è®º ({{comments.length}})</text>
    </view>

    <!-- å‘è¡¨è¯„è®º -->
    <view class="comment-form card" wx:if="{{isLoggedIn}}">
      <textarea 
        class="comment-input" 
        placeholder="{{replyTo ? 'å›å¤ @' + replyTo.nickname + 'ï¼š' : 'å†™ä¸‹ä½ çš„è¯„è®º...'}}"
        value="{{commentContent}}" 
        bindinput="onCommentInput"
        maxlength="1000"
        auto-height
      />
      <view class="comment-actions">
        <view class="comment-info">
          <text class="text-xs text-muted">{{commentContent.length}}/1000</text>
          <text class="text-xs text-primary ml-20" wx:if="{{replyTo}}" bindtap="cancelReply">å–æ¶ˆå›å¤</text>
        </view>
        <button 
          class="btn-comment {{commentContent.trim().length > 0 ? 'active' : ''}}" 
          disabled="{{commentContent.trim().length === 0 || commenting}}"
          bindtap="submitComment"
        >
          {{commenting ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ'}}
        </button>
      </view>
    </view>

    <!-- æœªç™»å½•æç¤º -->
    <view class="login-tip card" wx:if="{{!isLoggedIn}}">
      <text class="text-sm text-muted">è¯·å…ˆç™»å½•ä»¥å‚ä¸è®¨è®º</text>
      <text class="text-sm text-primary ml-20" bindtap="goToLogin">å»ç™»å½•</text>
    </view>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <view class="comments-list">
      <view class="comment-item card" wx:for="{{comments}}" wx:key="id">
        <view class="comment-header">
          <view class="commenter-info">
            <view class="avatar avatar-sm">
              {{item.nickname ? item.nickname.charAt(0) : item.username.charAt(0)}}
            </view>
            <view class="commenter-details">
              <text class="commenter-name text-sm">{{item.nickname || item.username}}</text>
              <text class="comment-time text-xs text-muted">{{item.formatted_time}}</text>
            </view>
          </view>
          
          <view class="comment-actions">
            <text class="reply-btn text-xs text-primary" bindtap="replyToComment" data-comment="{{item}}">å›å¤</text>
          </view>
        </view>
        
        <view class="comment-content">
          <!-- å¦‚æœæ˜¯å›å¤è¯„è®ºï¼Œæ˜¾ç¤ºè¢«å›å¤çš„ç”¨æˆ· -->
          <view class="reply-to" wx:if="{{item.reply_to_nickname}}">
            <text class="text-sm text-primary">@{{item.reply_to_nickname}}</text>
          </view>
          <text class="comment-text text-sm">{{item.content}}</text>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty" wx:if="{{comments.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ’¬</view>
      <text class="text-base">è¿˜æ²¡æœ‰è¯„è®º</text>
      <text class="text-sm text-muted mt-10">æˆä¸ºç¬¬ä¸€ä¸ªè¯„è®ºçš„äººå§ï¼</text>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading" wx:if="{{loading}}">
    <text class="text-sm text-muted">åŠ è½½ä¸­...</text>
  </view>
</view>
